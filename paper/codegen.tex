\section{C Code Generation}

The translation of \PikaCore{} function into C is divided into the stages.

\begin{enumerate}
  \item \label{stage:in-out} For each branch, determine the abstract heap for the input and a collection of
    heaplets for the output.
  \item Generate the appropriate assignment statements, \verb|malloc| calls, etc from the
    previous stage
\end{enumerate}

\subsection{Examples}

\subsubsection{leftList}
First, lets look at a \Pika{} function that takes a tree and gives back a list by traversing the leftmost branches.

\begin{lstlisting}
%generate leftList[TreeLayout, Sll]

data List := Nil | Cons Int List;
data Tree := Tip | Node Int Tree Tree;

Sll : layout(List);
Sll Nil := emp;
Sll (Cons h t) := x :-> h, (x+1) :-> t, Sll t;

TreeLayout : layout(Tree);
TreeLayout Tip := emp;
TreeLayout (Node v left right) :=
  y :-> v, (y+1) :-> left, (y+2) :-> right,
  TreeLayout left, TreeLayout right;

leftList : (a ~ layout(Tree), b ~ layout(List)) => a -> b
leftList Tip := Nil;
leftList [a b] (Node v left right) :=
  Cons v ($\instExpr_{\verb|a|,\verb|b|}$(leftList) left);
\end{lstlisting}

\noindent
This is first translated into \PikaCore:

\begin{lstlisting}
leftList' : SSL(1) -> SSL(1)
leftList' {} = ssl {}
leftList' {x :-> h, (x+1) :-> left, (x+2) :-> right} =
  with nxt := leftList' {left} : SSL(1)
  in
  ssl {y :-> h, (y+1) :-> nxt}
\end{lstlisting}

\noindent
In Stage~\ref{stage:in-out}

