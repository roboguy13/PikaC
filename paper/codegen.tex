\section{C Code Generation}

The translation of \PikaCore{} function into C is divided into the stages.

\begin{enumerate}
  \item \label{stage:in-out} For each branch, determine the abstract heap for the input and a collection of
    heaplets for the output.
  \item Generate the appropriate assignment statements, \verb|malloc| calls, etc from the
    previous stage
\end{enumerate}

\subsection{Examples}

\subsubsection{leftList}
First, lets look at a \Pika{} function that takes a tree and gives back a list by traversing the leftmost branches.

\begin{lstlisting}
%generate leftList[TreeLayout, Sll]

data List := Nil | Cons Int List;
data Tree := Tip | Node Int Tree Tree;

Sll : layout(List);
Sll Nil := emp;
Sll (Cons h t) := x :-> h, (x+1) :-> t, Sll t;

TreeLayout : layout(Tree);
TreeLayout Tip := emp;
TreeLayout (Node v left right) :=
  y :-> v, (y+1) :-> left, (y+2) :-> right,
  TreeLayout left, TreeLayout right;

leftList : (a ~ layout(Tree), b ~ layout(List)) =>
  a -> b
leftList Tip := Nil;
leftList [a b] (Node v left right) :=
  Cons v (leftList$_{\verb|a|,\verb|b|}$ left);
\end{lstlisting}

\noindent
This is first translated into \PikaCore:

\begin{lstlisting}
leftList' : SSL(1) -> SSL(1)
leftList' {} = ssl {}
leftList' {x :-> h, (x+1) :-> left, (x+2) :-> right} =
  with t := leftList' {left}
  in
  ssl {y :-> h, (y+1) :-> t}
\end{lstlisting}

\noindent
Generated C code:

\begin{lstlisting}
typedef struct Sll {
  int x_0;
  Sll* x_1;
};

typedef struct TreeLayout {
  int y_0;
  TreeLayout* y_1;
  TreeLayout* y_2;
};

void leftList(TreeLayout* arg, Sll** r) {
  if (arg == 0) {
      // pattern match {}

      // ssl {}
    *r = 0;
  } else {
      // pattern match {x :-> h, (x+1) :-> left
      //               , (x+2) :-> right}
    int v = arg->y_0;
    TreeLayout* left = arg->y_1;
    TreeLayout* right = arg->y_2;

      // with t := leftList' {left} in ...
    Sll* t = 0;
    leftList(left, &t);

      // ssl {y :-> h, (y+1) :-> t}
    *r = malloc(sizeof(Sll));
    *r->x_0 = v;
    *r->x_1 = t;
  }
}
\end{lstlisting}

% \noindent
% In Stage~\ref{stage:in-out}

