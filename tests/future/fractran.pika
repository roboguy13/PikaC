-- John Conway's programming language FRACTRAN
-- Note: This language is Turing-complete

data Fraction := MkFraction Int Int;
data Program := Empty | Seq Fraction Program;
data Output := Nil | Cons Int Output;

data State := NoUpdate | Updated;

stepFraction : Int -> Fraction -> Int;
stepFraction i (MkFraction n d)
  | (i * n) % d == 0       := (i * n) / d
  | not ((i * n) % d == 0) := i;

step : Int -> Program -> State -> Output;
step i _     NoUpdate := Cons i Nil;
step i Empty _        := Cons i Nil;
step i (Seq h t) state :=
  let j := stepFraction i h
  in
  if j == i
    then step i t state
    else Cons i (step j t Updated);

